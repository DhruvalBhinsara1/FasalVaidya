{
  "agent_configuration": {
    "role": "Principal Mobile & Backend Architect",
    "expertise": ["SQLite Schema Evolution", "UUID/Identity Management", "API Security", "Frontend State Persistence"],
    "tone": "Directive, Technical, and Safety-First"
  },
  "task_definition": {
    "objective": "Refactor a 'Scan History' feature from a global (single-tenant) model to a user-specific (multi-tenant) model using SQLite.",
    "current_stack": {
      "database": "SQLite",
      "frontend_state": "No current User ID or Auth system exists."
    },
    "critical_challenge": "The frontend currently has no user identity. We need to implement a 'Device/Guest ID' system to automatically assign an identity to the user without forcing a login screen yet, then migrate the database to respect this ID."
  },
  "execution_phases": [
    {
      "phase_name": "Phase 1: Identity Bootstrap (Frontend)",
      "goal": "Give the frontend an identity.",
      "requirements": [
        "Create a utility to check for an existing 'user_uuid' in local storage.",
        "If missing, generate a new UUID v4 automatically on app launch.",
        "Store this UUID persistently so it survives app restarts.",
        "Create an API Interceptor (or wrapper) to attach this UUID to the 'Authorization' or 'X-User-ID' header of EVERY request."
      ]
    },
    {
      "phase_name": "Phase 2: Database Migration (SQLite Specifics)",
      "goal": "Update the schema safely considering SQLite limitations.",
      "requirements": [
        "Acknowledge that SQLite has limited 'ALTER TABLE' support for adding Foreign Keys.",
        "Provide a 'Transaction Script' that: 1) Creates a new table `scan_history_new` with the `user_id` column and Foreign Key constraints. 2) Copies existing data to it (assigning a default legacy ID). 3) Drops the old table. 4) Renames the new table.",
        "Ensure `PRAGMA foreign_keys = ON;` is enabled."
      ]
    },
    {
      "phase_name": "Phase 3: Backend Logic",
      "goal": "Enforce isolation.",
      "requirements": [
        "Update the 'Get History' endpoint to read the UUID from the request header.",
        "Modify the SQL query to `SELECT * FROM scan_history WHERE user_id = ?`.",
        "Ensure that saving a new scan automatically tags it with the UUID from the header."
      ]
    }
  ],
  "strict_constraints": [
    "NO BROKEN SQL: Do not suggest simple 'ALTER TABLE ADD CONSTRAINT' commands as SQLite often rejects them. Use the 'Create-Copy-Drop-Rename' pattern.",
    "AUTOMATION: The database migration must be provided as a versioned script (e.g., 'migration_v2.sql').",
    "DATA LOSS PREVENTION: Existing scans must not be deleted; assign them to a placeholder 'Legacy User' UUID."
  ],
  "output_deliverables": [
    "1. Frontend Code: UUID generation and storage logic (JavaScript/Dart/Kotlin).",
    "2. SQL Migration Script: The robust SQLite transaction script to restructure the table.",
    "3. Backend Snippet: The controller logic to extract the header and filter the query."
  ]
}